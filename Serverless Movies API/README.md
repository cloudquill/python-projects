# Serverless Movies API

## Overview

This serverless function provides a simple API for accessing movie 
information stored in a database. It includes several endpoints to retrieve a list of movies, filter movies by release year, and generate summaries for specific movies using AI.

The deployment of this function can also be managed using a Terraform file, ensuring a seamless and reproducible infrastructure setup.

## Features

- **GetMovies**: Returns a JSON list of all movies in the database.
- **GetMoviesByYear**: Returns a list of movies released in a specified year, as provided by the user.
- **GetMovieSummary**: Returns a generated summary for a specified movie using AI.

## API Endpoints

### 1. GetMovies

**Endpoint**: `/getmovies`

**Description**: Returns a JSON array of all movies in the database.

### 2. GetMoviesByYear

**Endpoint**: `/getmoviesbyyear/<year>`  
**Query Parameter**: `year` (required)

**Description**: Returns a list of movies that were released in the specified year.

**Example Request**:
```
/getmoviesbyyear/2009
```

### 3. GetMovieSummary

**Endpoint**: `/getmoviesummary/<movie_name>`  
**Query Parameter**: `movie_name` (required)

**Description**: Returns a summary generated by AI for the specified movie title.

**Example Request**:
```
/getmoviesummary/Avatar
```

## Setup Instructions

1. **Clone the Repository**

2. **Install Dependencies**:
   Make sure you have the necessary dependencies installed. Run this with Python installed:
   ```python
   pip install -r requirements.txt
   ```

3. **Obtain a trial API key from Cohere AI**:
    Sign up to [Cohere AI](https://cohere.com/) to get a free API key you can use to generate movie summaries:
    - From the sidebar, click on "API Keys"
    - Click on "New Trial Key"
    - Fill in a name for the key and click on generate
    - Copy the key  

3. **Configure Environment Variables**:
   Set up environment variables for the storage account connection and AI service access in a `.env` file:
   - `ACCOUNT_URI`
   - `ACCOUNT_KEY`
   - `COHERE_API_KEY`  

   **Note**: This applies only to local testing. Azure handles environment variables differently, so dotenv is unnecessary and causes errors in the Azure environment. Before deploying to Azure, comment out the dotenv import and load_dotenv() call in the config file, and remove python-dotenv from `requirements.txt`.

4. **Deploying Your Azure Function with Secrets**:
   Before deploying your Azure Function, copy the secrets from your `.env` file to `local.settings.json`. This ensures the Function App has all required settings to run; otherwise, you might encounter the "No HTTP triggers found" error.

   ![No HTTP triggers error](/Serverless%20Movies%20API/images/no_http_triggers_error.jpg?raw=true "No HTTP triggers found")

   Example `local.settings.json`: 
   ```JSON
   {
      "IsEncrypted": false,
      "Values": {
         "FUNCTIONS_WORKER_RUNTIME": "python",
         "AzureWebJobsFeatureFlags": "EnableWorkerIndexing",
         "ACCOUNT_URI": "xxxxxxxxxxxxxxxxxxx",
         "ACCOUNT_KEY": "xxxxxxxxxxxxxxxxxxxx",
         "COHERE_API_KEY": "xxxxxxxxxxxxxxxxxx"

      }
   }
   ```

   ![Deploying to Azure](/Serverless%20Movies%20API/images/serverless%20movies%20pic.jpg?raw=true "Steps to deploying function to Azure")

Now it is much easier to deploy to Azure with VS Code:
   - Install the Azure Function extension.
   - Click the Azure Function icon in the sidebar.
   - Hover over the **WORKSPACE** header and click the little Azure Function icon that appears.
   - Select "Deploy to Azure" from the dropdown and follow the prompts.
   - After deployment, a notification will appear in the bottom-right corner of VS Code. Click **"Upload settings"** to transfer the secrets from `local.settings.json` to your Azure Function.

   ![Upload settings](/Serverless%20Movies%20API/images/upload_settings.jpg?raw=true "Upload settings notification")

   - Restart your Function App by pressing the F1 key to open the command pallete in VS Code. Type and click on "Azure Functions: Restart". Then choose the Function to restart. 
   - Once restarted, open the Function App in the Azure Portal. You should see your three trigger functions listed in the **Overview** window.

## Troubleshooting Common Issues
If your function still doesn't work after deployment, try these solutions:

1. **Run the Function Locally**:  
Test the function locally to ensure it works as expected before deploying.

2. **Remove dotenv for Deployment**:
- Comment out the dotenv import and the load_dotenv() call in your config file.
- Remove python-dotenv from the requirements.txt file.
- Redeploy the function.

3. **Verify Secrets on Azure**:
- Go to your Function App in the Azure Portal.
- In the sidebar, expand the Settings tab and click Environment Variables.
- Ensure all required secrets (ACCOUNT_URI, ACCOUNT_KEY and COHERE_API_KEY) are correctly uploaded.

## Contributing

Contributions are welcome! Please open an issue or submit a pull request if you'd like to contribute.

## License

This project is licensed under the MIT License. See the LICENSE file for details.

## Acknowledgments

- [Movie Dataset from rand.fun](https://github.com/randfun/movies-dataset)
- [Cohere AI](https://cohere.com/) for AI services.
